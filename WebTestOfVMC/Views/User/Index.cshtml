
@using WebTestOfVMC.Models
@using Microsoft.AspNetCore.Mvc.TagHelpers
@using EnumExt;
@using Microsoft.AspNetCore.Mvc.Rendering;
@using CommonClasses.PaginationAndSort;
@using RailDBProject.Model;

@model IndexViewModel

<p class="filter-text">Пользователи</p>
<br />


<div class="table">

    <div id="manipulation-buttons">
        <div class="create-button">
            @await Component.InvokeAsync("UserInfo")
        </div>
        <div class="edit-button">
            @await Component.InvokeAsync("UpdateUser")
        </div>
        <div class="delete-button">
            <input type="submit" class="btn btn-outline-dark" value="Удалить" id="delete-btn" />
        </div>
        <div class="filters">
            <form method="get">
                <div class="form-inline">

                    <p1 class="p1">Организация: </p1>
                    <select name="company" asp-items="Model.FilterViewModel.Organisations" class="form-control"></select>

                    <input type="submit" value="Применить фильтр" class="btn btn-outline-dark" />
                </div>
            </form>
        </div>
    </div>

    <table class="table">
        <tr class="p1 intable">
            <th>
                <p class="p1">№ п/п</p>
            </th>
            <th>
                <a asp-action="Index"
                   asp-controller="User"
                   asp-route-sortOrder="@(Model.SortViewModel.LastNameSort)"
                   asp-route-name="@(Model.FilterViewModel.SelectedName)"
                   asp-route-company="@(Model.FilterViewModel.SelectedOrganisation)"><p class="p1">Фамилия</p></a>
            </th>

            <th>
                <a asp-action="Index"
                   asp-controller="User"
                   asp-route-sortOrder="@(Model.SortViewModel.FirstNameSort)"
                   asp-route-name="@(Model.FilterViewModel.SelectedName)"
                   asp-route-company="@(Model.FilterViewModel.SelectedOrganisation)"><p class="p1">Имя</p></a>
            </th>

            <th>
                <a asp-action="Index"
                   asp-controller="User"
                   asp-route-sortOrder="@(Model.SortViewModel.MiddleNameSort)"
                   asp-route-name="@(Model.FilterViewModel.SelectedName)"
                   asp-route-company="@(Model.FilterViewModel.SelectedOrganisation)"><p class="p1">Отчество</p></a>
            </th>

            <th>
                <a asp-action="Index"
                   asp-controller="User"
                   asp-route-sortOrder="@(Model.SortViewModel.OrganisationSort)"
                   asp-route-name="@(Model.FilterViewModel.SelectedName)"
                   asp-route-company="@(Model.FilterViewModel.SelectedOrganisation)"><p class="p1">Организация</p></a>
            </th>

            <th>
                <a asp-action="Index"
                   asp-controller="User"
                   asp-route-sortOrder="@(Model.SortViewModel.EmailSort)"
                   asp-route-name="@(Model.FilterViewModel.SelectedName)"
                   asp-route-company="@(Model.FilterViewModel.SelectedOrganisation)"><p class="p1">E-mail</p></a>
            </th>
            <th>
                <a asp-action="Index"
                   asp-controller="User"
                   asp-route-sortOrder="@(Model.SortViewModel.UserRoleSort)"
                   asp-route-name="@(Model.FilterViewModel.SelectedName)"
                   asp-route-company="@(Model.FilterViewModel.SelectedOrganisation)"><p class="p1">Группа</p></a>
            </th>


        </tr>

        @{ int rowNo = 0; }
        @foreach (User u in Model.Users)
        {


            <tr class="table-row" id="@u.UserId">
                <td>@(rowNo += 1)</td>
                <td>@u.LastName</td>
                <td>@u.FirstName</td>
                <td>@u.SurName</td>
                <td>@u.Organisation.OrgName</td>
                <td>@u.Email</td>
                <td>@u.UserRole.GetEnumDescription()</td>
            </tr>

        }

    </table>
</div>

@if (Model.PageViewModel.HasPreviousPage)
{
    <a asp-action="Index"
       asp-route-page="@(Model.PageViewModel.PageNumber - 1)"
       asp-route-name="@(Model.FilterViewModel.SelectedName)"
       asp-route-company="@(Model.FilterViewModel.SelectedOrganisation)"
       asp-route-sortorder="@(Model.SortViewModel.Current)"
       class="btn  btn-outline-dark">
        <i class="glyphicon glyphicon-chevron-left"></i>
        Назад
    </a>
}
@if (Model.PageViewModel.HasNextPage)
{
    <a asp-action="Index"
       asp-route-page="@(Model.PageViewModel.PageNumber + 1)"
       asp-route-name="@(Model.FilterViewModel.SelectedName)"
       asp-route-company="@(Model.FilterViewModel.SelectedOrganisation)"
       asp-route-sortorder="@(Model.SortViewModel.Current)"
       class="btn btn-outline-dark">
        Вперед
        <i class="glyphicon glyphicon-chevron-right"></i>
    </a>
}

@section Scripts{

    <script>

        function onSuccess(data) {
            $(document).on("ajaxSuccess", function () {
                
                    alert(data.newData.emailMessage);
                    window.location = data.newData.urladmin;
            });
        }

        var clicked = false;
        var element = null;

        $(document).ready(function () {

            $(".edit-button").hide();
            $(".delete-button").hide();

            $(".table-row").click(function () {

                if (!clicked)
                {
                    element = $(this).attr("id");
                    $(this).css({ 'backgroundColor': '#fff', 'color': '#000' });
                    clicked = true;
                    $(".edit-button").show();
                    $(".delete-button").show();
                }
                else
                {
                    if ($(this).attr("id") == element) {
                        $(this).css({ 'backgroundColor': '', 'color': '' });
                        clicked = false;
                        $(".edit-button").hide();
                        $(".delete-button").hide();
                    }
                    $(".table-row").click(function () { return false });
                };
            });

            $("#delete-btn").click(function () {
                $.ajax({
                    url: '@Url.Action("DeleteUser","User")',
                    type: 'POST',
                    dataType: 'html',
                    data: { id: element },
                    success: function (data) {
                        alert("Удаление прошло успешно!")
                        window.location.reload();
                    }
                });
            });





            $("#open_modal").click(function () {

                alert("...............");


            });

        });

    </script>
}



 @*$(".table-row").click(function () {

                if (!clicked) {
                    element = $(this).attr("id");
                    $(this).css({ 'backgroundColor': '#fff', 'color': '#000' });
                    clicked = true;
                    $(".edit-button").show();
                    $(".delete-button").show();
                }
                else if (clicked) {
                    if ($(this).attr("id") == element) {
                        $(this).css();
                        $(".edit-button").hide();
                        $(".delete-button").hide();
                        clicked = false;
                    }
                    else {
                        $(".table-row").click(function () { return false });
                    }
                };
            });*@